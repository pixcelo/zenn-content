# 音声コマンド機能

このドキュメントでは、Whisper.netサンプルアプリケーションの音声コマンド機能について説明します。

## 概要

音声コマンド機能は、マイクに向かって話すことでアプリケーションを操作できる機能です。
**プッシュ・トゥ・トーク方式**を採用し、ボタンを押している間だけ音声を録音・認識します。

## 特徴

### ✅ 利点

- **PC負荷が最小限**: 使用時のみCPU・メモリを使用（待機時は0%）
- **誤認識を防止**: ボタンを押した時だけ認識するため、意図しない操作を防止
- **シンプルな操作**: ボタンを押しながら話すだけ
- **業務アプリに最適**: オフィス環境でも安全に使用可能

### ⚙️ 技術仕様

- **認識エンジン**: Whisper.net (OpenAI Whisper)
- **録音形式**: 16kHz Mono WAV
- **言語**: 日本語
- **モデル**: メイン画面で選択中のモデルを使用

## 使い方

### 基本操作

1. **🎤 音声コマンド**ボタンを**マウスで押し続ける**
2. ボタンを押している間に**コマンドを発話**（1-3秒程度）
3. ボタンを**離す**と自動的に認識開始
4. 認識結果がステータス欄に表示され、該当する操作が実行される

### 操作例

#### ダイアログを開く
```
1. 🎤ボタンを押す
2. 「ポップアップを開いて」と発話
3. ボタンを離す
→ ポップアップダイアログが表示される
```

#### ダイアログを閉じる
```
1. 🎤ボタンを押す
2. 「ポップアップを閉じて」と発話
3. ボタンを離す
→ 開いているポップアップが閉じる
```

#### ヘルプを表示
```
1. 🎤ボタンを押す
2. 「ヘルプ」と発話
3. ボタンを離す
→ 利用可能なコマンド一覧が表示される
```

## 利用可能なコマンド一覧

### 【ダイアログ操作】

| トリガーフレーズ | 動作 |
|-----------------|------|
| 「ポップアップを開いて」<br>「ダイアログ表示」<br>「ダイアログを開く」<br>「ポップアップ表示」 | ポップアップダイアログを表示します |
| 「ポップアップを閉じて」<br>「ダイアログを閉じる」<br>「閉じて」 | 開いているポップアップを閉じます |

### 【アプリ操作】

| トリガーフレーズ | 動作 |
|-----------------|------|
| 「録音開始」<br>「録音スタート」<br>「レコーディング開始」 | 音声の録音を開始します |
| 「録音停止」<br>「ストップ」<br>「録音終了」 | 録音を停止します |
| 「文字起こし実行」<br>「文字起こし」<br>「トランスクリプション実行」 | 音声ファイルの文字起こしを実行します |
| 「結果をエクスポート」<br>「エクスポート」<br>「保存」 | 文字起こし結果をエクスポートします |

### 【ヘルプ】

| トリガーフレーズ | 動作 |
|-----------------|------|
| 「ヘルプ」<br>「コマンド一覧」<br>「使い方」 | 利用可能な音声コマンドの一覧を表示します |

## コマンド認識の仕組み

### 部分一致検出

音声認識結果に含まれるフレーズを検出します。

**例**:
- 認識結果: 「えーと、ポップアップを開いてください」
- → 「ポップアップを開いて」が検出され、ダイアログが開く

### 複数トリガー対応

1つのコマンドに複数のトリガーフレーズを登録しています。

**例**:
- 「ポップアップを開いて」
- 「ダイアログ表示」
- 「ダイアログを開く」

→ どれを話しても同じ動作が実行されます

### 正規化処理

認識結果は以下の処理を経てマッチング判定されます：

1. 前後の空白除去
2. 小文字化
3. 部分一致判定

## パフォーマンス特性

### リソース使用量

| 状態 | CPU使用率 | メモリ使用量 |
|------|----------|-------------|
| **待機時** | 0% | 0MB (追加負荷なし) |
| **録音中** | ~1% | ~10MB |
| **認識中** | 5-15% | モデルサイズに依存<br>(Base: 140MB、Large: 2.9GB) |

### 処理時間

- **録音時間**: 1-3秒（ユーザーが話す時間）
- **認識時間**: 0.5-2秒（モデルと音声の長さに依存）
- **合計**: 約1.5-5秒

## トラブルシューティング

### Q. 「マイクが見つかりません」と表示される

**原因**: マイクデバイスが接続されていない、または認識されていない

**対策**:
1. マイクが正しく接続されているか確認
2. Windowsの「サウンド設定」でマイクが有効になっているか確認
3. 他のアプリケーションでマイクが使用できるか確認

### Q. 音声が認識されない

**原因**:
- 音声が小さすぎる
- 発話時間が短すぎる
- 雑音が多い

**対策**:
1. マイクに近づいて、はっきりと話す
2. 1-3秒程度の長さで発話する
3. 静かな環境で試す
4. Windowsの「サウンド設定」でマイクの音量を上げる

### Q. コマンドが見つからない

**認識結果**: 「コマンドが見つかりませんでした: 「○○○」」

**対策**:
1. 「ヘルプ」コマンドで利用可能なコマンド一覧を確認
2. トリガーフレーズを正確に発話する
3. ゆっくり・はっきり話す

**例**:
- ❌ 「ダイアログ」 → 短すぎて認識できない
- ✅ 「ダイアログを開く」 → 正しく認識される

### Q. 認識が遅い

**原因**: 大きなWhisperモデル（Large、Medium）を使用している

**対策**:
1. メイン画面のモデル選択で「Base」または「Tiny」を選択
2. 音声コマンドには軽量モデルで十分な精度

## 設計思想

### なぜプッシュ・トゥ・トーク方式？

#### 代替案: 常時音声認識（ウェイクワード方式）

```
❌ 問題点:
- 常時CPU・メモリを消費（5-15%）
- 誤認識リスク（雑談・電話会議中に誤動作）
- プライバシー問題（常時音声を監視）
- バッテリー消費が大きい
```

#### 採用案: プッシュ・トゥ・トーク方式

```
✅ 利点:
- CPU負荷が最小限（使用時のみ）
- 誤認識がほぼゼロ
- プライバシー安全（ボタン押下時のみ録音）
- 業務環境に最適
- 実装がシンプル
```

### 業務アプリとしての実用性

#### 想定シーン

1. **ハンズフリー操作が必要な時**
   - 資料を持ちながら画面を操作
   - キーボード・マウスが手元にない

2. **繰り返し操作の効率化**
   - 「録音開始」→作業→「録音停止」→「文字起こし実行」のフロー
   - マウス移動不要で素早く操作

3. **アクセシビリティ向上**
   - マウス・キーボード操作が困難なユーザー向け

#### 業務環境での安全性

- **誤動作防止**: プッシュ・トゥ・トークにより意図しない操作を防止
- **プライバシー**: ボタン押下時のみ録音（常時監視なし）
- **低負荷**: 待機時のリソース使用ゼロ

## 開発者向け情報

### アーキテクチャ

```
┌─────────────────────────────────────┐
│         Form1 (UI)                  │
│  - btnVoiceCommand (プッシュボタン)  │
│  - labelVoiceCommandStatus          │
└─────────────────────────────────────┘
               ↓
┌─────────────────────────────────────┐
│   VoiceCommandManager               │
│  - RegisterCommand()                │
│  - ProcessRecognizedText()          │
│  - GenerateHelpMessage()            │
└─────────────────────────────────────┘
               ↓
┌─────────────────────────────────────┐
│   VoiceCommand (コマンド定義)        │
│  - TriggerPhrases                   │
│  - Action                           │
│  - Description                      │
│  - Category                         │
└─────────────────────────────────────┘
```

### 処理フロー

```
ユーザーがボタン押下
  ↓
btnVoiceCommand_MouseDown()
  ↓
マイク録音開始 (16kHz Mono)
  ↓
ユーザーが発話 (1-3秒)
  ↓
ユーザーがボタンを離す
  ↓
btnVoiceCommand_MouseUp()
  ↓
録音停止・WAVファイル保存
  ↓
ProcessVoiceCommandAsync()
  ↓
Whisperで音声認識
  ↓
VoiceCommandManager.ProcessRecognizedText()
  ↓
VoiceCommand.Matches() で該当コマンド検索
  ↓
VoiceCommand.Execute() でアクション実行
  ↓
OnCommandRecognized() イベント発火
  ↓
ステータス表示更新
```

### カスタムコマンドの追加方法

`Form1.cs` の `RegisterVoiceCommands()` メソッドに追加：

```csharp
_voiceCommandManager.RegisterCommand(new VoiceCommand
{
    TriggerPhrases = new[] { "コマンド1", "コマンド2", "別の表現" },
    Action = () =>
    {
        // 実行したい処理
        MessageBox.Show("カスタムコマンドが実行されました");
    },
    Description = "カスタムコマンドの説明",
    Category = "カスタム"
});
```

### API リファレンス

#### VoiceCommand クラス

| プロパティ | 型 | 説明 |
|-----------|---|------|
| TriggerPhrases | string[] | コマンドを起動するフレーズの配列 |
| Action | Action | 実行されるアクション |
| Description | string | コマンドの説明（ヘルプ表示用） |
| Category | string | カテゴリ名（分類用） |
| IsEnabled | bool | コマンドの有効/無効 |

| メソッド | 戻り値 | 説明 |
|---------|-------|------|
| Matches(string) | bool | 認識テキストがこのコマンドにマッチするか判定 |
| Execute() | void | コマンドを実行 |

#### VoiceCommandManager クラス

| メソッド | 戻り値 | 説明 |
|---------|-------|------|
| RegisterCommand(VoiceCommand) | void | コマンドを登録 |
| ProcessRecognizedText(string) | bool | 認識テキストからコマンドを検索・実行 |
| GenerateHelpMessage() | string | ヘルプメッセージを生成 |
| GetCommandsByCategory(string) | IEnumerable<VoiceCommand> | 指定カテゴリのコマンド一覧 |
| EnableAllCommands() | void | すべてのコマンドを有効化 |
| DisableAllCommands() | void | すべてのコマンドを無効化 |

| イベント | 引数 | 説明 |
|---------|------|------|
| CommandRecognized | VoiceCommandRecognizedEventArgs | コマンドが認識された時 |
| CommandNotFound | string | コマンドが見つからなかった時 |

## 今後の拡張可能性

### ON/OFFトグルモード

プッシュ・トゥ・トークとトグル方式を切り替え可能にする：

```
□ トグルモード
  - ON時: 自動的に音声を認識し続ける
  - OFF時: プッシュ・トゥ・トークに戻る
```

### ホットキー対応

キーボードショートカットで音声コマンド起動：

```
Ctrl+Alt+V → 音声コマンド録音開始
キーを離す → 認識実行
```

### カスタムコマンド管理UI

ユーザーが独自のコマンドを登録できるUI：

```
[コマンド管理]ボタン
  → 設定ダイアログ
  → トリガーフレーズとアクションを登録
```

### 音声フィードバック

コマンド実行時に音声で応答：

```
「ポップアップを開いて」
→ 「ポップアップを開きました」(音声合成)
```

## 参考リンク

- [Whisper.net GitHub](https://github.com/sandrohanea/whisper.net)
- [NAudio ドキュメント](https://github.com/naudio/NAudio)
- [OpenAI Whisper 論文](https://arxiv.org/abs/2212.04356)
