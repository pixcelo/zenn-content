@page "/valuetype-vs-referencetype"
@using BlazorDataBindingSample.Models
@rendermode InteractiveServer

<PageTitle>å€¤å‹ vs å‚ç…§å‹ã®ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°</PageTitle>

<h1>å€¤å‹ vs å‚ç…§å‹ã®ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°</h1>

<div class="alert alert-info">
    <h5>ğŸ“š ã“ã®ãƒšãƒ¼ã‚¸ã§å­¦ã¶ã“ã¨</h5>
    <p class="mb-0">
        Blazorã®ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã«ãŠã„ã¦ã€<strong>å€¤å‹ï¼ˆint, decimal, DateTime, structç­‰ï¼‰</strong>ã¨<strong>å‚ç…§å‹ï¼ˆclass, Listç­‰ï¼‰</strong>ã§æŒ™å‹•ãŒã©ã†é•ã†ã®ã‹ã‚’å®Ÿé¨“ã—ã¾ã™ã€‚
        ã“ã‚Œã¯Blazorã«é™ã‚‰ãšã€C#ã®åŸºç¤çš„ãªæ¦‚å¿µã§ã™ãŒã€ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã§é‡è¦ã«ãªã‚Šã¾ã™ã€‚
    </p>
</div>

<div class="card">
    <div class="card-header bg-warning bg-opacity-25">
        <h3>å®Ÿé¨“1: å€¤å‹ã®ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆintï¼‰</h3>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h5>è¦ªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ</h5>
                <p>ç¾åœ¨ã®å€¤: <strong>@valueTypeInt</strong></p>
                <p>ãƒãƒƒã‚·ãƒ¥ã‚³ãƒ¼ãƒ‰: <code>@valueTypeInt.GetHashCode()</code></p>
                <div class="input-group">
                    <button class="btn btn-primary" @onclick="() => valueTypeInt++">+1</button>
                    <button class="btn btn-secondary ms-2" @onclick="() => valueTypeInt--">-1</button>
                </div>
            </div>
            <div class="col-md-6">
                <ValueTypeTestComponent @bind-Value="valueTypeInt" />
            </div>
        </div>

        <div class="alert alert-warning mt-3">
            <strong>âš ï¸ é‡è¦ãªæŒ™å‹•:</strong>
            <ul class="mb-0">
                <li>å€¤å‹ã¯ã‚³ãƒ”ãƒ¼æ¸¡ã—ã•ã‚Œã‚‹</li>
                <li>å­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§å€¤ã‚’å¤‰æ›´ã—ã¦ã‚‚ã€è¦ªã®å€¤ã¯è‡ªå‹•ã§å¤‰ã‚ã‚‰ãªã„</li>
                <li><code>EventCallback</code> ã§æ˜ç¤ºçš„ã«é€šçŸ¥ã™ã‚‹å¿…è¦ãŒã‚ã‚‹</li>
                <li><code>@@bind-Value</code> ã¯ <code>Value</code> + <code>ValueChanged</code> ã®çµ„ã¿åˆã‚ã›</li>
            </ul>
        </div>
    </div>
</div>

<div class="card mt-3">
    <div class="card-header bg-info bg-opacity-25">
        <h3>å®Ÿé¨“2: å‚ç…§å‹ã®ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆclassï¼‰</h3>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h5>è¦ªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ</h5>
                @if (referenceTypeModel != null)
                {
                    <p>ID: <strong>@referenceTypeModel.Id</strong></p>
                    <p>Name: <strong>@referenceTypeModel.Name</strong></p>
                    <p>Value: <strong>@referenceTypeModel.Value</strong></p>
                    <p>ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè­˜åˆ¥å­: <code>@referenceTypeModel.GetIdentity()</code></p>
                }
                <button class="btn btn-primary" @onclick="ResetReferenceModel">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
            <div class="col-md-6">
                <ReferenceTypeTestComponent @bind-Model="referenceTypeModel" />
            </div>
        </div>

        <div class="alert alert-info mt-3">
            <strong>âœ… é‡è¦ãªæŒ™å‹•:</strong>
            <ul class="mb-0">
                <li>å‚ç…§å‹ã¯å‚ç…§æ¸¡ã—ã•ã‚Œã‚‹ï¼ˆåŒã˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æŒ‡ã™ï¼‰</li>
                <li>å­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å¤‰æ›´ã™ã‚‹ã¨ã€è¦ªå´ã‚‚è‡ªå‹•ã§å¤‰ã‚ã‚‹</li>
                <li>ãŸã ã—ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè‡ªä½“ã‚’æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ç½®ãæ›ãˆãŸå ´åˆã¯è¦ªã«é€šçŸ¥ãŒå¿…è¦</li>
                <li>ãƒãƒƒã‚·ãƒ¥ã‚³ãƒ¼ãƒ‰ï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè­˜åˆ¥å­ï¼‰ã‚’è¦‹ã‚‹ã¨ã€åŒã˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã‚ã‚‹ã“ã¨ãŒç¢ºèªã§ãã‚‹</li>
            </ul>
        </div>
    </div>
</div>

<div class="card mt-3">
    <div class="card-header bg-success bg-opacity-25">
        <h3>å®Ÿé¨“3: è¤‡é›‘ãªã‚±ãƒ¼ã‚¹ï¼ˆå‚ç…§å‹ã®ä¸­ã®å€¤å‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ï¼‰</h3>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h5>è¦ªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ</h5>
                @if (nestedModel != null)
                {
                    <p>Counterï¼ˆå€¤å‹ï¼‰: <strong>@nestedModel.Counter</strong></p>
                    <p>Item.Nameï¼ˆå‚ç…§å‹å†…ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ï¼‰: <strong>@nestedModel.Item?.Name</strong></p>
                    <p>ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè­˜åˆ¥å­: <code>@nestedModel.GetHashCode():X8</code></p>
                }
                <button class="btn btn-primary" @onclick="IncrementNested">Counter +1</button>
                <button class="btn btn-warning ms-2" @onclick="ChangeNestedItemName">Item.Nameå¤‰æ›´</button>
            </div>
            <div class="col-md-6">
                <div class="border rounded p-3 bg-success bg-opacity-10">
                    <h5>å­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰</h5>
                    @if (nestedModel != null && nestedModel.Item != null)
                    {
                        <p>å—ã‘å–ã£ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ:</p>
                        <p>Counter: @nestedModel.Counter</p>
                        <p>Item.Name: @nestedModel.Item.Name</p>
                        <div class="input-group mb-2">
                            <span class="input-group-text">Counter</span>
                            <input type="number" class="form-control" @bind="nestedModel.Counter" @bind:event="oninput" />
                        </div>
                        <div class="input-group">
                            <span class="input-group-text">Item.Name</span>
                            <input type="text" class="form-control" @bind="nestedModel.Item.Name" @bind:event="oninput" />
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="alert alert-success mt-3">
            <strong>ğŸ” è¦³å¯Ÿãƒã‚¤ãƒ³ãƒˆ:</strong>
            <ul class="mb-0">
                <li><code>nestedModel</code> è‡ªä½“ã¯å‚ç…§å‹ãªã®ã§ã€å­ã§ã®å¤‰æ›´ãŒè¦ªã«ã‚‚åæ˜ ã•ã‚Œã‚‹</li>
                <li><code>Counter</code> ã¯å€¤å‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã ãŒã€<code>nestedModel</code> ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãªã®ã§å¤‰æ›´ãŒè¦ªã«ã‚‚è¦‹ãˆã‚‹</li>
                <li><code>Item.Name</code> ã‚‚åŒæ§˜ã«ã€åŒã˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãªã®ã§å¤‰æ›´ãŒå…±æœ‰ã•ã‚Œã‚‹</li>
                <li>ã¤ã¾ã‚Šã€å‚ç…§å‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ï¼ˆå€¤å‹ãƒ»å‚ç…§å‹å•ã‚ãšï¼‰ã‚’å¤‰æ›´ã™ã‚‹ã¨ã€è¦ªå­ã§åŒæœŸã•ã‚Œã‚‹</li>
            </ul>
        </div>
    </div>
</div>

<div class="card mt-3">
    <div class="card-header">
        <h3>ğŸ“Š å‹•ä½œãƒ­ã‚°</h3>
    </div>
    <div class="card-body">
        @if (logs.Any())
        {
            <div style="max-height: 300px; overflow-y: auto;">
                <ul class="list-group">
                    @foreach (var log in logs.TakeLast(20).Reverse())
                    {
                        <li class="list-group-item list-group-item-sm py-1">
                            <small><code>[@log.Time]</code> @log.Message</small>
                        </li>
                    }
                </ul>
            </div>
            <button class="btn btn-sm btn-secondary mt-2" @onclick="ClearLogs">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
        }
        else
        {
            <p class="text-muted">ã¾ã ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</p>
        }
    </div>
</div>

<div class="card mt-3">
    <div class="card-header bg-primary bg-opacity-25">
        <h3>ğŸ’¡ ã¾ã¨ã‚ï¼šå®Ÿå‹™ã§ã®ä½¿ã„åˆ†ã‘</h3>
    </div>
    <div class="card-body">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>ç¨®é¡</th>
                    <th>ä¾‹</th>
                    <th>å­ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã®æŒ™å‹•</th>
                    <th>EventCallbackå¿…è¦æ€§</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>å€¤å‹</strong></td>
                    <td>int, decimal, DateTime, bool, struct</td>
                    <td>ã‚³ãƒ”ãƒ¼ã•ã‚Œã‚‹ã®ã§ã€å¤‰æ›´ã¯è¦ªã«å½±éŸ¿ã—ãªã„</td>
                    <td>âœ… å¿…è¦ï¼ˆ@@bind-ã§è‡ªå‹•ç”Ÿæˆå¯èƒ½ï¼‰</td>
                </tr>
                <tr>
                    <td><strong>å‚ç…§å‹</strong></td>
                    <td>class, List, Dictionary</td>
                    <td>åŒã˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å‚ç…§ã™ã‚‹ã®ã§ã€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å¤‰æ›´ã¯è¦ªã«ã‚‚åæ˜ </td>
                    <td>âš ï¸ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å¤‰æ›´æ™‚ã¯ä¸è¦ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç½®æ›æ™‚ã¯å¿…è¦</td>
                </tr>
                <tr>
                    <td><strong>å‚ç…§å‹å†…ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£</strong></td>
                    <td>model.Counter, model.Name</td>
                    <td>åŒã˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãªã®ã§ã€è¦ªã«ã‚‚åæ˜ </td>
                    <td>âŒ ä¸è¦ï¼ˆè‡ªå‹•ã§åŒæœŸï¼‰</td>
                </tr>
            </tbody>
        </table>

        <div class="alert alert-warning">
            <strong>âš ï¸ ã‚ˆãã‚ã‚‹é–“é•ã„:</strong>
            <ul class="mb-0">
                <li>å€¤å‹ã‚’ <code>@@bind</code> ãªã—ã§æ¸¡ã™ã¨ã€å­ã§ã®å¤‰æ›´ãŒè¦ªã«åæ˜ ã•ã‚Œãªã„ã“ã¨ã«æ°—ã¥ã‹ãªã„</li>
                <li>å‚ç…§å‹ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å¤‰æ›´ã§ <code>StateHasChanged()</code> ã‚’å‘¼ã³å¿˜ã‚Œã€UIãŒæ›´æ–°ã•ã‚Œãªã„</li>
                <li>å‚ç…§å‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ–°è¦ä½œæˆã—ãŸå¾Œã€è¦ªã«é€šçŸ¥ã—å¿˜ã‚Œã‚‹</li>
            </ul>
        </div>
    </div>
</div>

@code {
    // å€¤å‹ã®ä¾‹
    private int valueTypeInt = 10;

    // å‚ç…§å‹ã®ä¾‹
    private ReferenceTypeModel? referenceTypeModel;

    // è¤‡é›‘ãªä¾‹
    private NestedModel? nestedModel;

    // ãƒ­ã‚°
    private List<(string Time, string Message)> logs = new();

    protected override void OnInitialized()
    {
        referenceTypeModel = new ReferenceTypeModel(1, "åˆæœŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ", 100.50m);
        nestedModel = new NestedModel
        {
            Counter = 0,
            Item = new ReferenceTypeModel(1, "ãƒã‚¹ãƒˆã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ", 50.0m)
        };

        AddLog("ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆæœŸåŒ–å®Œäº†");
    }

    private void ResetReferenceModel()
    {
        var oldHash = referenceTypeModel?.GetHashCode().ToString("X8") ?? "null";
        referenceTypeModel = new ReferenceTypeModel(1, "ãƒªã‚»ãƒƒãƒˆã•ã‚ŒãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ", 100.50m);
        var newHash = referenceTypeModel.GetHashCode().ToString("X8");

        AddLog($"å‚ç…§å‹ãƒ¢ãƒ‡ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ: {oldHash} â†’ {newHash}");
    }

    private void IncrementNested()
    {
        if (nestedModel != null)
        {
            nestedModel.Counter++;
            AddLog($"Counter ã‚’ {nestedModel.Counter} ã«ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ");
        }
    }

    private void ChangeNestedItemName()
    {
        if (nestedModel?.Item != null)
        {
            nestedModel.Item.Name = $"å¤‰æ›´_{DateTime.Now:HHmmss}";
            AddLog($"Item.Name ã‚’å¤‰æ›´: {nestedModel.Item.Name}");
        }
    }

    private void AddLog(string message)
    {
        logs.Add((DateTime.Now.ToString("HH:mm:ss.fff"), message));
    }

    private void ClearLogs()
    {
        logs.Clear();
    }
}
