@page "/prerendering-test"
@rendermode InteractiveServer

<PageTitle>プリレンダリング検証</PageTitle>

<h1>プリレンダリング検証</h1>

<div class="alert alert-info">
    <h5>プリレンダリングとは？</h5>
    <p>
        Blazor Server の Interactive Server モードでは、デフォルトでプリレンダリングが有効になっています。
        これは、初回アクセス時にサーバー側でHTMLを生成してからクライアントに送信し、
        その後SignalR接続が確立されてインタラクティブになる仕組みです。
    </p>
</div>

<div class="card">
    <div class="card-header">
        <h3>ライフサイクルメソッドの呼び出し順序</h3>
    </div>
    <div class="card-body">
        <p>プリレンダリングが有効な場合、ライフサイクルメソッドは以下の順序で呼ばれます：</p>
        <ol class="list-group list-group-numbered">
            @foreach (var log in lifecycleLogs)
            {
                <li class="list-group-item">@log</li>
            }
        </ol>

        <button class="btn btn-primary mt-3" @onclick="AddLog">ボタンクリック</button>
    </div>
</div>

<div class="card mt-3">
    <div class="card-header">
        <h3>JavaScript相互運用の制限</h3>
    </div>
    <div class="card-body">
        <p>プリレンダリング時にはJavaScript相互運用は使用できません（ブラウザがまだ存在しないため）。</p>

        <button class="btn btn-success" @onclick="CallJavaScript">JavaScript呼び出し</button>

        @if (!string.IsNullOrEmpty(jsResult))
        {
            <div class="alert alert-success mt-2">
                結果: @jsResult
            </div>
        }

        @if (!string.IsNullOrEmpty(jsError))
        {
            <div class="alert alert-danger mt-2">
                エラー: @jsError
            </div>
        }
    </div>
</div>

<div class="card mt-3">
    <div class="card-header">
        <h3>StateHasChanged()のタイミング</h3>
    </div>
    <div class="card-body">
        <p>現在のカウント: <strong>@count</strong></p>
        <p>最終更新: <strong>@lastUpdate</strong></p>

        <button class="btn btn-primary" @onclick="IncrementCount">カウント増加</button>
        <button class="btn btn-secondary ms-2" @onclick="IncrementWithDelay">遅延付きカウント増加</button>

        <div class="mt-3">
            <p class="text-muted">
                StateHasChanged()を呼び出すと、コンポーネントが再レンダリングされます。
                プリレンダリング時とインタラクティブ時で動作が異なることがあります。
            </p>
        </div>
    </div>
</div>

<div class="card mt-3">
    <div class="card-header">
        <h3>データバインディングの動作</h3>
    </div>
    <div class="card-body">
        <div class="mb-3">
            <label class="form-label">リアルタイム更新 (oninput):</label>
            <input class="form-control" @bind="realtimeValue" @bind:event="oninput" />
            <p class="mt-2">値: <strong>@realtimeValue</strong> (長さ: @realtimeValue.Length)</p>
        </div>

        <div class="mb-3">
            <label class="form-label">フォーカス外れ時更新 (onchange):</label>
            <input class="form-control" @bind="onChangeValue" @bind:event="onchange" />
            <p class="mt-2">値: <strong>@onChangeValue</strong></p>
        </div>

        <div class="alert alert-warning">
            <strong>注意:</strong> プリレンダリング時は入力値が保持されません。
            SignalR接続確立後に初めてバインディングが機能します。
        </div>
    </div>
</div>

<div class="card mt-3">
    <div class="card-header">
        <h3>レンダリングモードの確認</h3>
    </div>
    <div class="card-body">
        <p>OnAfterRender実行回数: <strong>@afterRenderCount</strong></p>
        <p>現在の接続状態: <strong>@connectionState</strong></p>
        <p>初回レンダリング完了: <strong>@(isFirstRenderComplete ? "はい" : "いいえ")</strong></p>

        <div class="mt-3">
            <h5>判定方法:</h5>
            <ul>
                <li>OnAfterRender(firstRender: true) → プリレンダリング後の初回レンダリング</li>
                <li>OnAfterRender(firstRender: false) → 2回目以降のレンダリング</li>
                <li>JavaScript実行可能 → インタラクティブモード</li>
            </ul>
        </div>
    </div>
</div>
